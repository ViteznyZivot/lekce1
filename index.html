<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protokol Genesis: Blockchain Simulátor + AI</title>
    <!-- Google Fonts: Orbitron pro futuristický vzhled -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS pro rychlé stylování UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js pro 3D grafiku -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Rajdhani', sans-serif;
            color: white;
            user-select: none;
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* UI Vrstva */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* Umožní klikat skrz prázdná místa */
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.6) 100%);
        }

        /* Interaktivní prvky musí mít pointer-events: auto */
        .interactive {
            pointer-events: auto;
        }

        /* Skleněný efekt pro panely */
        .glass-panel {
            background: rgba(10, 20, 40, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
        }

        h1, h2, h3, .tech-font {
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
        }

        /* Draggable items */
        .data-block {
            background: linear-gradient(90deg, rgba(0, 100, 255, 0.2), rgba(0, 20, 60, 0.8));
            border-left: 4px solid #00d4ff;
            transition: all 0.3s ease;
            cursor: grab;
            position: relative;
            overflow: hidden;
        }

        .data-block:hover {
            transform: translateX(10px);
            background: linear-gradient(90deg, rgba(0, 150, 255, 0.4), rgba(0, 40, 100, 0.8));
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        }
        
        .data-block:active {
            cursor: grabbing;
        }

        /* Drop Zone - neviditelná oblast uprostřed */
        #drop-zone {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Border pouze pro debugging, v produkci transparentní */
            border: 2px dashed rgba(0, 255, 255, 0); 
            transition: all 0.3s;
        }

        #drop-zone.drag-over {
            border: 2px dashed rgba(0, 255, 255, 0.5);
            background: rgba(0, 255, 255, 0.1);
        }

        /* Seal Button */
        #seal-btn {
            background: transparent;
            border: 2px solid #00d4ff;
            color: #00d4ff;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s;
            opacity: 0.5;
            cursor: not-allowed;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }

        #seal-btn.ready {
            opacity: 1;
            cursor: pointer;
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.4);
            animation: pulse-border 2s infinite;
        }

        #seal-btn.ready:hover {
            background: #00d4ff;
            color: black;
            box-shadow: 0 0 50px rgba(0, 212, 255, 0.8);
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 10px rgba(0, 212, 255, 0.2); }
            50% { box-shadow: 0 0 25px rgba(0, 212, 255, 0.6); }
            100% { box-shadow: 0 0 10px rgba(0, 212, 255, 0.2); }
        }

        /* Text Animations */
        .glow-text-blue {
            text-shadow: 0 0 10px #00d4ff;
        }
        .glow-text-red {
            text-shadow: 0 0 10px #ff3300;
        }

        /* Scanning line effect */
        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 255, 0.5);
            position: absolute;
            top: 0;
            animation: scan 3s linear infinite;
            opacity: 0.3;
        }
        @keyframes scan {
            0% { top: 0; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .status-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
        }
        .status-pending { background: rgba(0, 212, 255, 0.2); color: #00d4ff; border: 1px solid #00d4ff; }
        .status-sealed { background: rgba(255, 51, 0, 0.2); color: #ff5500; border: 1px solid #ff5500; }

        /* Notification Toast */
        #notification {
            transform: translateY(-100px);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #notification.show {
            transform: translateY(0);
        }

        /* AI Buttons */
        .ai-btn {
            font-size: 0.65rem;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .ai-btn:hover {
            filter: brightness(1.2);
            box-shadow: 0 0 10px currentColor;
        }
        
        /* Custom Scrollbar for Oracle */
        #oracle-response::-webkit-scrollbar { width: 4px; }
        #oracle-response::-webkit-scrollbar-thumb { background: #8b5cf6; border-radius: 2px; }
        #oracle-response::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }

        /* AI Loading Animation */
        .typing-dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            background-color: currentColor;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin-left: 2px;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

    </style>
</head>
<body>

    <!-- 3D Scene Container -->
    <div id="canvas-container"></div>

    <!-- AI Analysis Modal -->
    <div id="ai-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center backdrop-blur-sm pointer-events-auto">
        <div class="glass-panel p-6 rounded-xl max-w-lg w-full border border-cyan-500 shadow-[0_0_50px_rgba(0,212,255,0.3)] transform transition-all scale-95 opacity-0" id="ai-modal-content">
            <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center border-b border-cyan-500/30 pb-2">
                <span class="mr-2 animate-pulse">✨</span> DEKRYPCE DAT
            </h3>
            <div id="ai-modal-body" class="text-gray-200 font-mono text-sm leading-relaxed min-h-[100px]">
                Inicializace neurálního spojení...
            </div>
            <button id="close-ai-modal" class="mt-6 w-full py-2 bg-cyan-900/50 hover:bg-cyan-700/50 text-cyan-100 rounded border border-cyan-500 transition-colors uppercase tracking-widest text-xs font-bold interactive">
                Zavřít spojení
            </button>
        </div>
    </div>

    <!-- UI Overlay -->
    <div id="ui-layer" class="flex flex-col justify-between p-6">
        
        <!-- Header -->
        <div class="flex justify-between items-start w-full pointer-events-none">
            <div class="glass-panel p-4 rounded-br-2xl border-t-0 border-l-0">
                <h1 class="text-3xl font-bold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-600 glow-text-blue">
                    PROTOKOL <span class="text-white">GENESIS</span>
                </h1>
                <p class="text-cyan-400 text-sm tracking-wider mt-1 opacity-80">VIZUALIZACE DISTRIBUOVANÉ KNIHY</p>
            </div>
            
            <div class="glass-panel p-4 rounded-bl-2xl border-t-0 border-r-0 text-right">
                <div class="text-xs text-gray-400 mb-1">STAV SÍTĚ</div>
                <div class="text-green-400 font-bold tech-font tracking-widest">ONLINE • SYNCRO</div>
                <div class="text-xs text-gray-500 mt-1">AI ORACLE: <span class="text-purple-400">AKTIVNÍ</span></div>
            </div>
        </div>

        <!-- Floating Instructions (Center Top) -->
        <div id="instruction-text" class="absolute top-32 left-1/2 transform -translate-x-1/2 text-center transition-all duration-500">
            <p class="text-cyan-300 text-lg tracking-[0.2em] font-bold bg-black bg-opacity-50 px-4 py-1 rounded border border-cyan-900">
                PŘETÁHNĚTE DATA DO PRÁZDNÉHO BLOKU
            </p>
            <div class="w-1 h-8 bg-gradient-to-b from-cyan-500 to-transparent mx-auto mt-2"></div>
        </div>

        <!-- Middle Section: Sidebar & Center Interaction -->
        <div class="flex-grow flex items-center w-full relative">
            
            <!-- Left Sidebar: Transaction Pool -->
            <div class="w-80 glass-panel p-0 rounded-r-2xl border-l-0 interactive transform transition-transform hover:translate-x-2 z-20">
                <div class="p-4 border-b border-gray-700 bg-black bg-opacity-40 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl text-white tracking-wider flex items-center">
                            <span class="w-2 h-2 bg-blue-500 rounded-full mr-3 animate-pulse"></span>
                            MEMPOOL
                        </h2>
                        <p class="text-xs text-gray-400 mt-1">Čekající transakce</p>
                    </div>
                </div>
                
                <div class="p-4 space-y-4 max-h-[50vh] overflow-y-auto">
                    <!-- Draggable Transaction A -->
                    <div class="data-block p-4 rounded cursor-move group" draggable="true" id="tx-a">
                        <div class="flex justify-between items-center mb-2">
                            <span class="status-badge status-pending">PENDING</span>
                            <button class="ai-btn bg-purple-900/40 text-purple-300 border border-purple-500/50 px-2 py-0.5 rounded hover:bg-purple-800" onclick="analyzeTransaction('0x3f...a9', 'Transakce A')">
                                ✨ DEKÓDOVAT
                            </button>
                        </div>
                        <div class="text-white font-bold text-lg">Transakce A</div>
                        <div class="text-xs text-cyan-300 mt-1 flex items-center">
                            <span class="text-[10px] opacity-70 mr-1">HASH:</span> 0x3f...a9
                        </div>
                        <div class="scanline"></div>
                    </div>

                    <!-- Draggable Transaction B (Highlighted in prompt) -->
                    <div class="data-block p-4 rounded cursor-move group border-l-4 border-cyan-400" draggable="true" id="tx-b">
                        <div class="flex justify-between items-center mb-2">
                            <span class="status-badge status-pending animate-pulse">PENDING</span>
                            <button class="ai-btn bg-purple-900/40 text-purple-300 border border-purple-500/50 px-2 py-0.5 rounded hover:bg-purple-800" onclick="analyzeTransaction('0x8b...2c', 'Transakce B')">
                                ✨ DEKÓDOVAT
                            </button>
                        </div>
                        <div class="text-white font-bold text-lg glow-text-blue">Transakce B</div>
                        <div class="text-xs text-cyan-300 mt-1 flex items-center">
                            <span class="text-[10px] opacity-70 mr-1">HASH:</span> 0x8b...2c
                        </div>
                        <div class="scanline"></div>
                    </div>

                    <!-- Draggable Transaction C -->
                    <div class="data-block p-4 rounded cursor-move group" draggable="true" id="tx-c">
                        <div class="flex justify-between items-center mb-2">
                            <span class="status-badge status-pending">PENDING</span>
                            <button class="ai-btn bg-purple-900/40 text-purple-300 border border-purple-500/50 px-2 py-0.5 rounded hover:bg-purple-800" onclick="analyzeTransaction('0x1a...f4', 'Transakce C')">
                                ✨ DEKÓDOVAT
                            </button>
                        </div>
                        <div class="text-white font-bold text-lg">Transakce C</div>
                        <div class="text-xs text-cyan-300 mt-1 flex items-center">
                            <span class="text-[10px] opacity-70 mr-1">HASH:</span> 0x1a...f4
                        </div>
                        <div class="scanline"></div>
                    </div>
                </div>
            </div>

            <!-- Invisible Drop Zone over the 3D block -->
            <div id="drop-zone" class="interactive">
                <!-- Visual feedback when dragging over -->
                <div id="drop-feedback" class="hidden flex-col items-center justify-center text-cyan-400 opacity-0 transition-opacity duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                    <span class="mt-2 text-sm bg-black bg-opacity-70 px-2 py-1 rounded">VLOŽIT DATA</span>
                </div>
            </div>

        </div>

        <!-- Footer / Controls -->
        <div class="w-full flex justify-center pb-8 relative pointer-events-none">
            <div class="absolute bottom-10 left-10 text-xs text-red-500 tracking-widest opacity-70">
                <div>NEZMĚNITELNOST.</div>
                <div>CHRÁNĚNO KRYPTOGRAFIÍ.</div>
            </div>

            <!-- AI Oracle Panel (New) -->
            <div class="absolute bottom-6 right-6 z-20 w-80 interactive">
                <div class="glass-panel p-4 rounded-xl border-l-4 border-l-purple-500 transition-all duration-300 hover:shadow-[0_0_20px_rgba(139,92,246,0.2)]">
                    <h3 class="text-sm font-bold text-purple-300 mb-2 flex items-center tracking-wider">
                        <span class="mr-2">✨</span> GENESIS ORACLE
                    </h3>
                    <div id="oracle-response" class="text-xs text-gray-300 mb-3 hidden max-h-32 overflow-y-auto leading-relaxed border-b border-gray-700 pb-2"></div>
                    <div class="flex">
                        <input type="text" id="oracle-input" placeholder="Zeptejte se na blockchain..." class="bg-black bg-opacity-50 border border-purple-500/30 rounded-l px-3 py-2 text-xs w-full text-white focus:outline-none focus:border-purple-500 placeholder-gray-600 font-mono">
                        <button id="oracle-btn" class="bg-purple-900/50 border border-purple-500/30 border-l-0 rounded-r px-3 text-purple-300 hover:bg-purple-800 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Action Button -->
            <button id="seal-btn" class="interactive px-12 py-4 text-xl font-bold uppercase rounded-sm bg-black bg-opacity-80 backdrop-blur-sm z-10">
                ZPEČETIT BLOK
            </button>
            
            <div class="absolute bottom-10 right-96 mr-8 text-xs text-gray-500 tracking-widest text-right">
                <div>BLOCK HEIGHT: <span id="block-height" class="text-white">845,231</span></div>
                <div>POSLEDNÍ HASH: <span class="text-red-400">0000...a8f2</span></div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="notification" class="absolute top-4 left-1/2 transform -translate-x-1/2 glass-panel px-6 py-3 rounded-lg border-t-2 border-green-500 flex items-center space-x-3 shadow-2xl z-50">
            <div class="w-3 h-3 bg-green-500 rounded-full animate-ping"></div>
            <span class="text-white font-bold tracking-wider" id="notif-text">DATA ÚSPĚŠNĚ VLOŽENA</span>
        </div>
    </div>

    <!-- Script Logic -->
    <script>
        // --- Gemini API Setup ---
        const apiKey = ""; // API key is injected by the environment

        async function callGemini(prompt, systemInstruction = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            if (systemInstruction) {
                payload.systemInstruction = { parts: [{ text: systemInstruction }] };
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Chyba při dekódování dat.";
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "Spojení s AI uzlem přerušeno. Zkuste to znovu.";
            }
        }

        // --- AI Feature 1: Transaction Analysis ---
        const aiModal = document.getElementById('ai-modal');
        const aiModalContent = document.getElementById('ai-modal-content');
        const aiModalBody = document.getElementById('ai-modal-body');
        const closeAiModalBtn = document.getElementById('close-ai-modal');

        async function analyzeTransaction(hash, name) {
            // Stop drag event propagation issues
            event.stopPropagation();
            
            // Show Modal
            aiModal.classList.remove('hidden');
            setTimeout(() => {
                aiModalContent.classList.remove('scale-95', 'opacity-0');
                aiModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            aiModalBody.innerHTML = `<span class="text-cyan-400">Analyzuji hash ${hash}...</span><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;

            // Call API
            const systemPrompt = "Jsi bezpečnostní AI Protokolu Genesis. Analyzuj tuto fiktivní blockchainovou transakci a vymysli pro ni krátký, kreativní, sci-fi obsah (např. převod lodi, smart kontrakt pro těžbu, tajná zpráva). Buď stručný (max 2-3 věty) a používej technický žargon. Jazyk: Čeština.";
            const userPrompt = `Analyzuj transakci: ${name} s hashem ${hash}. Co obsahuje?`;

            const result = await callGemini(userPrompt, systemPrompt);
            
            // Typewriter effect for result
            aiModalBody.innerHTML = "";
            let i = 0;
            const speed = 20;
            function typeWriter() {
                if (i < result.length) {
                    aiModalBody.innerHTML += result.charAt(i);
                    i++;
                    setTimeout(typeWriter, speed);
                }
            }
            typeWriter();
        }

        closeAiModalBtn.addEventListener('click', () => {
            aiModalContent.classList.remove('scale-100', 'opacity-100');
            aiModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                aiModal.classList.add('hidden');
            }, 200);
        });

        // --- AI Feature 2: Genesis Oracle ---
        const oracleInput = document.getElementById('oracle-input');
        const oracleBtn = document.getElementById('oracle-btn');
        const oracleResponse = document.getElementById('oracle-response');

        async function askOracle() {
            const question = oracleInput.value.trim();
            if (!question) return;

            oracleResponse.classList.remove('hidden');
            oracleResponse.innerHTML = `<span class="text-purple-400">Konzultuji databázi...</span>`;
            
            const systemPrompt = "Jsi Protokol Genesis AI, pokročilá entita spravující blockchain. Odpověz uživateli na jeho otázku o blockchainu nebo kryptoměnách. Vysvětli to jednoduše, ale zachovej futuristický, lehce robotický tón. Odpověď musí být v češtině a krátká (do 60 slov).";
            
            const result = await callGemini(question, systemPrompt);
            oracleResponse.innerText = result;
            oracleInput.value = "";
        }

        oracleBtn.addEventListener('click', askOracle);
        oracleInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askOracle();
        });


        // --- 3D Scene Setup (Three.js) ---
        const scene = new THREE.Scene();
        // Dark blue fog for depth
        scene.fog = new THREE.FogExp2(0x050510, 0.035); 
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- Materials & Geometries ---
        
        // Past Block (Red/Solidified)
        const pastMaterial = new THREE.MeshPhysicalMaterial({
            color: 0xff3300,
            emissive: 0x550000,
            roughness: 0.2,
            metalness: 0.8,
            transparent: true,
            opacity: 0.8,
            transmission: 0.2
        });

        // Active Block (Cyan/Empty/Glass)
        const activeMaterial = new THREE.MeshPhysicalMaterial({
            color: 0x00d4ff,
            emissive: 0x002244,
            roughness: 0.1,
            metalness: 0.5,
            transparent: true,
            opacity: 0.4,
            transmission: 0.6,
            side: THREE.DoubleSide
        });

        // Future Block (Wireframe)
        const futureMaterial = new THREE.LineBasicMaterial({ color: 0x222222 });

        // Connector Link (Energy Beam)
        const linkGeometry = new THREE.CylinderGeometry(0.1, 0.1, 3, 8);
        linkGeometry.rotateZ(Math.PI / 2);
        
        const blocks = [];
        const links = [];
        let particles;

        // --- Scene Construction Functions ---

        function createBlock(type, xPos) {
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            let mesh;
            
            if (type === 'future') {
                const wireframe = new THREE.WireframeGeometry(geometry);
                mesh = new THREE.LineSegments(wireframe, new THREE.LineBasicMaterial({ color: 0x333333 }));
            } else {
                mesh = new THREE.Mesh(geometry, type === 'past' ? pastMaterial : activeMaterial);
            }

            mesh.position.set(xPos, 0, 0);
            
            // Inner Core (Data representation)
            if (type === 'past') {
                const coreGeo = new THREE.IcosahedronGeometry(0.5, 0);
                const coreMat = new THREE.MeshBasicMaterial({ color: 0xffaa00, wireframe: true });
                const core = new THREE.Mesh(coreGeo, coreMat);
                mesh.add(core);
                
                // Protective Shield Light
                const light = new THREE.PointLight(0xff3300, 1, 5);
                mesh.add(light);
            } else if (type === 'active') {
                // Empty core initially
                const light = new THREE.PointLight(0x00d4ff, 1.5, 8);
                light.name = 'activeLight';
                mesh.add(light);
            }

            scene.add(mesh);
            blocks.push({ mesh: mesh, type: type });
            return mesh;
        }

        function createLink(xPos) {
            const material = new THREE.MeshBasicMaterial({ 
                color: 0xffffff, 
                transparent: true, 
                opacity: 0.2 
            });
            const mesh = new THREE.Mesh(linkGeometry, material);
            mesh.position.set(xPos, 0, 0);
            scene.add(mesh);
            links.push(mesh);
            return mesh;
        }

        function createEnvironment() {
            // Particles
            const particleGeo = new THREE.BufferGeometry();
            const particleCount = 2000;
            const posArray = new Float32Array(particleCount * 3);

            for(let i = 0; i < particleCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 50;
            }

            particleGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particleMat = new THREE.PointsMaterial({
                size: 0.05,
                color: 0x00d4ff,
                transparent: true,
                opacity: 0.6,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(particleGeo, particleMat);
            scene.add(particles);

            // Grid Floor
            const gridHelper = new THREE.GridHelper(60, 60, 0x111111, 0x050510);
            gridHelper.position.y = -4;
            scene.add(gridHelper);

            // Ambient Light
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
        }

        // --- Initial Scene Population ---
        createEnvironment();
        
        // Block positions: x = -4 (Past), 0 (Active), 4 (Future)
        createBlock('past', -4);
        createLink(-2);
        const activeBlockMesh = createBlock('active', 0);
        createLink(2);
        createBlock('future', 4);

        camera.position.z = 7;
        camera.position.y = 1;
        camera.lookAt(0, 0, 0);

        // --- Animation Logic ---
        let time = 0;
        let dataInside = null; // Object inside active block
        let isSealed = false;

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;

            // Rotate particles slowly
            if(particles) particles.rotation.y = time * 0.05;

            // Pulse Active Block
            const activeBlock = blocks.find(b => b.type === 'active');
            if (activeBlock && !isSealed) {
                const scale = 1 + Math.sin(time * 3) * 0.01;
                activeBlock.mesh.scale.set(scale, scale, scale);
                
                const light = activeBlock.mesh.getObjectByName('activeLight');
                if(light) {
                    light.intensity = 1.5 + Math.sin(time * 5) * 0.5;
                }
            }

            // Animate Data Core inside Active Block if present
            if (dataInside) {
                dataInside.rotation.x += 0.02;
                dataInside.rotation.y += 0.03;
            }

            // Past blocks "Shield" pulsing effect
            blocks.forEach(b => {
                if (b.type === 'past') {
                    b.mesh.material.emissiveIntensity = 0.5 + Math.sin(time * 2 + b.mesh.position.x) * 0.2;
                }
            });

            renderer.render(scene, camera);
        }

        animate();

        // --- Drag & Drop Interaction Logic ---
        const dropZone = document.getElementById('drop-zone');
        const dropFeedback = document.getElementById('drop-feedback');
        const instructionText = document.getElementById('instruction-text');
        const sealBtn = document.getElementById('seal-btn');
        const draggables = document.querySelectorAll('.data-block');
        const notification = document.getElementById('notification');
        const blockHeightDisplay = document.getElementById('block-height');

        let draggedItem = null;

        // Setup Draggables
        draggables.forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedItem = item;
                // Make drop zone visible/active
                dropZone.classList.add('active');
                dropFeedback.parentElement.style.zIndex = 50;
                e.dataTransfer.effectAllowed = "move";
            });

            item.addEventListener('dragend', () => {
                dropZone.classList.remove('drag-over');
                dropFeedback.classList.add('hidden');
                dropFeedback.style.opacity = 0;
            });
        });

        // Setup Drop Zone
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
            dropZone.classList.add('drag-over');
            dropFeedback.classList.remove('hidden');
            setTimeout(() => dropFeedback.style.opacity = 1, 10);
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
            dropFeedback.style.opacity = 0;
            setTimeout(() => dropFeedback.classList.add('hidden'), 300);
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            if (!draggedItem || isSealed) return;

            // Visual UI Cleanup
            dropZone.classList.remove('drag-over');
            dropFeedback.style.opacity = 0;
            draggedItem.style.opacity = "0.5";
            draggedItem.setAttribute('draggable', 'false');
            draggedItem.querySelector('.status-badge').innerText = "LOADED";
            draggedItem.querySelector('.status-badge').classList.remove('status-pending');
            draggedItem.querySelector('.status-badge').classList.add('bg-cyan-500', 'text-black');

            // 3D Feedback: Add "Data" to the block
            addDataToBlock();

            // UI Feedback
            instructionText.innerHTML = `<p class="text-white text-lg font-bold bg-green-900 bg-opacity-80 px-4 py-1 rounded border border-green-500">DATA NAČTENA. PŘIPRAVENO K PODPISU.</p>`;
            sealBtn.removeAttribute('disabled');
            sealBtn.classList.add('ready');

            showNotification("TRANSAKCE VLOŽENA DO MEMPOOLU BLOKU");
        });

        function addDataToBlock() {
            // Create a geometric representation of the data inside the active block
            const geometry = new THREE.DodecahedronGeometry(0.6, 0);
            const material = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                emissive: 0x00d4ff,
                emissiveIntensity: 0.8,
                wireframe: true
            });
            dataInside = new THREE.Mesh(geometry, material);
            
            // Find active block
            const activeBlock = blocks.find(b => b.type === 'active');
            if(activeBlock) {
                activeBlock.mesh.add(dataInside);
            }
        }

        // --- Seal Block Logic ---
        sealBtn.addEventListener('click', () => {
            if (!sealBtn.classList.contains('ready')) return;

            sealBlockSequence();
        });

        function sealBlockSequence() {
            isSealed = true;
            sealBtn.classList.remove('ready');
            sealBtn.disabled = true;
            sealBtn.innerText = "OVĚŘOVÁNÍ...";
            
            showNotification("GENERUJI HASH... PROVÁDÍM POW...");

            // 1. Change Active Block Visuals to "Past" (Red/Secure)
            const activeBlock = blocks.find(b => b.type === 'active');
            
            // Animation for color change
            let colorProgress = 0;
            const colorInterval = setInterval(() => {
                colorProgress += 0.05;
                if(activeBlock.mesh.material.color) {
                    activeBlock.mesh.material.color.lerp(new THREE.Color(0xff3300), 0.1);
                    activeBlock.mesh.material.emissive.lerp(new THREE.Color(0x550000), 0.1);
                }
                
                const light = activeBlock.mesh.getObjectByName('activeLight');
                if(light) light.color.lerp(new THREE.Color(0xff3300), 0.1);

                if(colorProgress >= 1) {
                    clearInterval(colorInterval);
                    finalizeSeal();
                }
            }, 50);
        }

        function finalizeSeal() {
            // Update Text
            sealBtn.innerText = "BLOK ZPEČETĚN";
            sealBtn.style.borderColor = "#ff3300";
            sealBtn.style.color = "#ff3300";
            
            instructionText.innerHTML = `<p class="text-red-400 text-lg font-bold">BLOK NEMĚNNÝ. PŘIDÁN DO ŘETĚZCE.</p>`;

            // Update Block Height
            let height = parseInt(blockHeightDisplay.innerText.replace(/,/g, ''));
            blockHeightDisplay.innerText = (height + 1).toLocaleString();

            // Shift Animation (Everything moves left)
            const shiftSpeed = 0.1;
            let shiftedDistance = 0;
            
            const shiftInterval = setInterval(() => {
                shiftedDistance += shiftSpeed;
                
                // Move camera slightly to simulate chain movement
                // Alternatively, move all objects left
                blocks.forEach(b => b.mesh.position.x -= shiftSpeed);
                links.forEach(l => l.position.x -= shiftSpeed);

                if(shiftedDistance >= 4) { // Distance between blocks is 4
                    clearInterval(shiftInterval);
                    resetForNextBlock();
                }
            }, 20);
        }

        function resetForNextBlock() {
            // Convert old active to past in data structure
            const oldActive = blocks.find(b => b.type === 'active');
            oldActive.type = 'past';
            
            // Convert old future to active visual style (but keeping it simplified for demo)
            // Ideally we spawn new geometry, but let's just create a new setup for the loop
            
            // For the sake of this demo loop, let's reload the visual state slightly
            // or just notify user the demo cycle is complete.
            
            showNotification("NOVÝ BLOK VYTVOŘEN");
            
            // Create new future block and link off-screen right
            createLink(6); // current visual offset
            const newFuture = createBlock('future', 8);
            
            // The old 'future' block (now at x=0) becomes 'active'
            const pendingBlock = blocks.find(b => b.type === 'future' && Math.abs(b.mesh.position.x) < 0.5);
            
            if(pendingBlock) {
                // Transform wireframe to block
                const oldGeo = pendingBlock.mesh.geometry; // It's a line segments geo
                scene.remove(pendingBlock.mesh);
                blocks.splice(blocks.indexOf(pendingBlock), 1);
                
                const newActive = createBlock('active', 0); // Recreate at center
                
                // Reset Interaction
                isSealed = false;
                dataInside = null;
                sealBtn.innerText = "ZPEČETIT BLOK";
                sealBtn.style.borderColor = "#00d4ff";
                sealBtn.style.color = "#00d4ff";
                sealBtn.style.opacity = "0.5";
                
                instructionText.innerHTML = `<p class="text-cyan-300 text-lg tracking-[0.2em] font-bold bg-black bg-opacity-50 px-4 py-1 rounded border border-cyan-900">PŘETÁHNĚTE DATA DO PRÁZDNÉHO BLOKU</p>`;
                
                // Reset Draggables (Simulate new transactions coming in)
                draggables.forEach(d => {
                    d.style.opacity = "1";
                    d.setAttribute('draggable', 'true');
                    d.querySelector('.status-badge').innerText = "PENDING";
                    d.querySelector('.status-badge').classList.add('status-pending');
                    d.querySelector('.status-badge').classList.remove('bg-cyan-500', 'text-black');
                });
            }
        }

        function showNotification(text) {
            const notif = document.getElementById('notification');
            document.getElementById('notif-text').innerText = text;
            notif.classList.add('show');
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }

        // Resize Handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
